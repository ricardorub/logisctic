<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos Procesados - Retail</title>
    <!-- CDNs corregidos: SIN espacios -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --amarillo-vibrante: #FFEB3B;
            --amarillo-oscuro: #FBC02D;
            --gris-oscuro: #212529;
            --gris-claro: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--gris-claro);
            color: var(--gris-oscuro);
        }
        
        .navbar {
            background-color: var(--amarillo-vibrante) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--gris-oscuro) !important;
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--amarillo-vibrante) 0%, var(--amarillo-oscuro) 100%);
            padding: 60px 0;
            margin-bottom: 40px;
            border-radius: 0 0 20px 20px;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--amarillo-vibrante);
            border-bottom: none;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--amarillo-vibrante);
            border-color: var(--amarillo-oscuro);
            color: var(--gris-oscuro);
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background-color: var(--amarillo-oscuro);
            border-color: var(--amarillo-oscuro);
            color: var(--gris-oscuro);
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        
        .back-button {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        
        .back-button:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        .estado-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .estado-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .estado-optimo {
            background-color: #28a745;
            color: white;
        }
        
        .estado-atencion {
            background-color: #ffc107;
            color: black;
        }
        
        .estado-critico {
            background-color: #dc3545;
            color: white;
        }
        
        .metric-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .metric-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }
        
        .metric-details {
            flex-grow: 1;
        }
        
        .metric-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-description {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .recomendacion-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--amarillo-vibrante);
            background-color: #f8f9fa;
            border-radius: 0 5px 5px 0;
        }
        
        .clasificacion-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .clasificacion-optimo {
            background-color: #28a745;
            color: white;
        }
        
        .clasificacion-bajo {
            background-color: #17a2b8;
            color: white;
        }
        
        .clasificacion-largo {
            background-color: #ffc107;
            color: black;
        }
        
        .clasificacion-media {
            background-color: #6f42c1;
            color: white;
        }
        
        .clasificacion-alta {
            background-color: #fd7e14;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-warehouse me-2"></i>Logística Retail
            </a>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">Datos Procesados</h1>
            <p class="lead">Archivo: {{ filename }}</p>
            <p class="mb-0">{{ data|length }} registros procesados correctamente</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-table me-2"></i>Vista Previa de los Datos</h4>
                    <a href="/back_to_upload" class="btn back-button">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Gestión de Archivos
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Datos del Archivo Procesado</h5>
                        <span class="badge bg-primary">{{ data|length }} registros</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        {% for column in columns %}
                                            {% if column not in ['ESTADO', 'Tiempo de entrega (Días)', 'Cobertura (Días)', 'Frecuencia de pedidos por SKU (Días)',
                                                               'Clasificación Tiempo Entrega', 'Recomendación Tiempo Entrega', 'Riesgo Tiempo Entrega',
                                                               'Clasificación Cobertura', 'Recomendación Cobertura', 'Riesgo Cobertura',
                                                               'Clasificación Frecuencia', 'Recomendación Frecuencia'] %}
                                                <th>{{ column }}</th>
                                            {% endif %}
                                        {% endfor %}
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data %}
                                    <tr>
                                        {% for column in columns %}
                                            {% if column not in ['ESTADO', 'Tiempo de entrega (Días)', 'Cobertura (Días)', 'Frecuencia de pedidos por SKU (Días)',
                                                               'Clasificación Tiempo Entrega', 'Recomendación Tiempo Entrega', 'Riesgo Tiempo Entrega',
                                                               'Clasificación Cobertura', 'Recomendación Cobertura', 'Riesgo Cobertura',
                                                               'Clasificación Frecuencia', 'Recomendación Frecuencia'] %}
                                                <td>{{ row[column] }}</td>
                                            {% endif %}
                                        {% endfor %}
                                        {% set estado = row['ESTADO'] | lower %}
                                        {% set identificador = row[columns[0]] if columns and columns[0] and columns[0] != 'ESTADO' else 'N/A' %}
                                        <td>
                                            <span class="estado-badge estado-{{ estado }}" 
                                                  onclick='mostrarRecomendaciones("{{ identificador }}", {{ row | tojson }})'>
                                                {{ estado|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick='mostrarRecomendaciones("{{ identificador }}", {{ row | tojson }})'>
                                                <i class="fas fa-chart-bar me-1"></i>Ver Análisis
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Archivo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Archivo Original:</h6>
                                <p class="text-muted">{{ filename }}</p>
                                
                                <h6>Columnas Detectadas:</h6>
                                <ul class="list-unstyled">
                                    {% for column in columns %}
                                        {% if column not in ['ESTADO', 'Tiempo de entrega (Días)', 'Cobertura (Días)', 'Frecuencia de pedidos por SKU (Días)',
                                                           'Clasificación Tiempo Entrega', 'Recomendación Tiempo Entrega', 'Riesgo Tiempo Entrega',
                                                           'Clasificación Cobertura', 'Recomendación Cobertura', 'Riesgo Cobertura',
                                                           'Clasificación Frecuencia', 'Recomendación Frecuencia'] %}
                                            <li><span class="badge bg-secondary me-1">{{ loop.index }}</span> {{ column }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Estadísticas:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Total de registros:</strong> {{ data|length }}</li>
                                    <li><strong>Total de columnas:</strong> {{ columns|length }}</li>
                                    <li><strong>Registros críticos:</strong> {{ data | selectattr('ESTADO', 'equalto', 'critico') | list | length }}</li>
                                    <li><strong>Registros con atención:</strong> {{ data | selectattr('ESTADO', 'equalto', 'atencion') | list | length }}</li>
                                    <li><strong>Registros óptimos:</strong> {{ data | selectattr('ESTADO', 'equalto', 'optimo') | list | length }}</li>
                                    <li><strong>Estado:</strong> <span class="badge bg-success">Procesado con algoritmo avanzado</span></li>
                                </ul>
                                
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Tip:</strong> Haz clic en los badges de estado para ver el análisis completo con las tres métricas clave.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Recomendaciones -->
    <div class="modal fade" id="recomendacionesModal" tabindex="-1" aria-labelledby="recomendacionesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recomendacionesModalLabel">Análisis Detallado del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="recomendacionesModalBody">
                    <!-- Contenido dinámico se insertará aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2023 Logística Retail. Sistema de análisis de datos.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function mostrarRecomendaciones(producto, rowData) {
            const modal = new bootstrap.Modal(document.getElementById('recomendacionesModal'));
            const modalBody = document.getElementById('recomendacionesModalBody');
            const modalTitle = document.getElementById('recomendacionesModalLabel');
            
            let contenido = generarContenidoRecomendaciones(producto, rowData);
            
            modalTitle.textContent = `Análisis Detallado: ${producto}`;
            modalBody.innerHTML = contenido;
            modal.show();
        }
        
        function generarContenidoRecomendaciones(producto, rowData) {
            const estado = rowData.ESTADO || 'atencion';
            const tiempoEntrega = rowData['Tiempo de entrega (Días)'] || 'No disponible';
            const clasifTiempo = rowData['Clasificación Tiempo Entrega'] || 'No calculado';
            const recomTiempo = rowData['Recomendación Tiempo Entrega'] || 'No disponible';
            const riesgoTiempo = rowData['Riesgo Tiempo Entrega'] || 'No disponible';
            
            const cobertura = rowData['Cobertura (Días)'] || 'No disponible';
            const clasifCobertura = rowData['Clasificación Cobertura'] || 'No calculado';
            const recomCobertura = rowData['Recomendación Cobertura'] || 'No disponible';
            const riesgoCobertura = rowData['Riesgo Cobertura'] || 'No disponible';
            
            const frecuencia = rowData['Frecuencia de pedidos por SKU (Días)'] || 'No disponible';
            const clasifFrecuencia = rowData['Clasificación Frecuencia'] || 'No calculado';
            const recomFrecuencia = rowData['Recomendación Frecuencia'] || 'No disponible';
            
            let contenido = `
                <div class="mb-4">
                    <h4>${producto}</h4>
                    <div class="alert ${estado === 'optimo' ? 'alert-success' : estado === 'atencion' ? 'alert-warning' : 'alert-danger'}">
                        <strong>Estado General: ${estado.toUpperCase()}</strong>
                    </div>
                </div>
                
                <h5 class="mb-3">Métricas Calculadas</h5>
                
                <!-- Tiempo de Entrega -->
                <div class="metric-indicator">
                    <div class="metric-icon text-primary">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="metric-details">
                        <div class="metric-title">Tiempo de Entrega: ${tiempoEntrega} días</div>
                        <div class="metric-description">
                            <span class="clasificacion-badge ${getClasificacionClass(clasifTiempo)}">${clasifTiempo}</span>
                            <br><strong>Recomendación:</strong> ${recomTiempo}
                            <br><strong>Riesgo:</strong> ${riesgoTiempo}
                        </div>
                    </div>
                </div>
                
                <!-- Cobertura -->
                <div class="metric-indicator">
                    <div class="metric-icon text-success">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="metric-details">
                        <div class="metric-title">Cobertura de Stock: ${cobertura} días</div>
                        <div class="metric-description">
                            <span class="clasificacion-badge ${getClasificacionClass(clasifCobertura)}">${clasifCobertura}</span>
                            <br><strong>Recomendación:</strong> ${recomCobertura}
                            <br><strong>Riesgo:</strong> ${riesgoCobertura}
                        </div>
                    </div>
                </div>
                
                <!-- Frecuencia de Pedidos -->
                <div class="metric-indicator">
                    <div class="metric-icon text-warning">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="metric-details">
                        <div class="metric-title">Frecuencia de Pedidos: ${frecuencia} pedidos/día</div>
                        <div class="metric-description">
                            <span class="clasificacion-badge ${getClasificacionClass(clasifFrecuencia)}">${clasifFrecuencia}</span>
                            <br><strong>Recomendación:</strong> ${recomFrecuencia}
                        </div>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3">Recomendaciones Generales</h5>
                <div>
                    ${generarRecomendacionesGenerales(estado)}
                </div>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Nota:</strong> Este análisis se basa en el algoritmo de métricas de inventario con las tres dimensiones clave.
                </div>
            `;
            
            return contenido;
        }
        
        function getClasificacionClass(clasificacion) {
            if (!clasificacion) return '';
            
            if (clasificacion.includes('Óptimo')) return 'clasificacion-optimo';
            if (clasificacion.includes('Bajo')) return 'clasificacion-bajo';
            if (clasificacion.includes('Largo')) return 'clasificacion-largo';
            if (clasificacion.includes('Media')) return 'clasificacion-media';
            if (clasificacion.includes('Alta')) return 'clasificacion-alta';
            
            return '';
        }
        
        function generarRecomendacionesGenerales(estado) {
            let recomendaciones = '';
            
            switch(estado) {
                case 'optimo':
                    recomendaciones = `
                        <div class="recomendacion-item">
                            <strong>✅ Situación Óptima</strong>
                            <p>El producto muestra un excelente desempeño en todas las métricas clave del algoritmo.</p>
                            <ul>
                                <li>Mantener la estrategia actual de gestión de inventario</li>
                                <li>Continuar con los niveles actuales de stock de seguridad</li>
                                <li>Monitorear periódicamente para mantener la optimización</li>
                                <li>Considerar este producto como referencia para otros SKUs</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'atencion':
                    recomendaciones = `
                        <div class="recomendacion-item">
                            <strong>⚠️ Requiere Atención</strong>
                            <p>El producto muestra algunas áreas que necesitan mejora según el análisis multidimensional.</p>
                            <ul>
                                <li>Revisar y ajustar los niveles de stock de seguridad</li>
                                <li>Optimizar la frecuencia de pedidos según la clasificación</li>
                                <li>Evaluar la relación con proveedores para mejorar tiempos</li>
                                <li>Implementar monitoreo más frecuente de las métricas</li>
                                <li>Considerar ajustes en la estrategia de reposición</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'critico':
                    recomendaciones = `
                        <div class="recomendacion-item">
                            <strong>🔴 Situación Crítica</strong>
                            <p>El producto requiere intervención inmediata basada en el análisis de las tres métricas clave.</p>
                            <ul>
                                <li>Revisar urgentemente los niveles de inventario actuales</li>
                                <li>Contactar proveedores para mejorar plazos de entrega</li>
                                <li>Considerar alternativas de abastecimiento inmediato</li>
                                <li>Implementar plan de contingencia para evitar quiebres</li>
                                <li>Revisar estrategia de precios y promociones</li>
                                <li>Evaluar posibilidad de descontinuar si persisten los problemas</li>
                            </ul>
                        </div>
                    `;
                    break;
            }
            
            return recomendaciones;
        }
    </script>
</body>
</html>